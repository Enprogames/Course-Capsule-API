<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/icon.png" type="image/x-icon">
    <link rel ="stylesheet" href = "frontend/css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>Simple web request</title>
</head>
<body>
    <div id="message_box" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: lightblue; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
        <span id="message_content"></span>
        <button id="close_message" style="margin-left: 20px;">x</button>
    </div>

    <div id="login_page">
        <section id = "logo-section">
            <img src="frontend/images/white-transparent-logo.png" alt="Course capsule logo">
        </section>
        <section id="forms-section">
            
            <form method="post" id="login_request">
                <h1>Login</h1>
                <input type="text" name="username" placeholder="username"><br>
                <input type="password" name="password" placeholder="password"><br>
                <button type="submit">Submit</button>
            </form>

            <br>


            <form method="post" id="register_request">
                <h1>Register</h1>
                <input type="text" name="email" placeholder="email"><br>
                <input type="text" name="username" placeholder="username"><br>
                <input type="password" name="password" placeholder="password"><br>
                <button type="submit">Register</button>
            </form>
        </section>
    </div>

    <main id="main_container" style="display:none;">
        <h1>Courses</h1>
        <h2 id="username_message"></h2>
        <h2 id="email_message"></h2>
        <h2 id="role_message"></h2>
        <div id="posts"></div>
        <form method="post" id="logout_request">
            <button type="submit">Logout</button>
        </form>
    </main>

    <script>

        let server_url = 'http://localhost:8000';

        let userState = {
            isLoggedIn: false,
            username: null,
            email: null,
            role: null,
        };

        function roleAsString(role) {
            switch (role) {
                case 0:
                    return "User";
                case 1:
                    return "Teacher";
                case 2:
                    return "Admin";
                default:
                    throw new Error("Invalid role");
            }
        }

        function showMessage(message) {
            $('#message_content').text(message);
            $('#message_box').show();

            const timeout = setTimeout(() => {
                $('#message_box').hide();
            }, 6000); // Hide after 6 seconds

            $('#close_message').click(function() {
                $('#message_box').hide();
                clearTimeout(timeout); // Prevent the timeout from hiding the message if the user already closed it
            });
        }

        function updateUserState() {
            $.ajax({
                url: server_url + '/verify-token',
                type: 'GET',
                cache: false,
                async: false,
                xhrFields: { withCredentials: true },
                success: function(response) {

                    if (response.logged_in) {
                        userState.isLoggedIn = true;
                        userState.username = response.username;
                        userState.email = response.email;
                        userState.role = response.role;
                    } else {
                        userState.isLoggedIn = false;
                        userState.username = null;
                        userState.email = null;
                        userState.role = null;
                    }
                    console.log("User state updated:", userState);
                },
                error: function() {
                    console.log("Error updating user state.");
                    // Reset userState in case of error
                    userState.isLoggedIn = false;
                    userState.username = null;
                    userState.email = null;
                    userState.role = null;
                }
            });
        }

        function retrieveCourses() {
            $.ajax({
                url: server_url + '/courses',
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: function(response) {
                    console.log(response);
                    $('#posts').empty();
                    for (let i = 0; i < response.length; i++) {
                        $('#posts').append(`<p>${response[i].title}</p>`);
                    }
                },
                error: function() {
                    console.log("Error retrieving posts.");
                }
            });
        }


        function loadPageContent() {
            updateUserState();
            if (userState.isLoggedIn) {
                console.log("User is logged in.");
                // User is logged in, load the posts page or other content
                $('#login_page').hide();
                $('#main_container').show();
                $('#main_container #username_message').text(`Hello ${userState.username}`);
                $('#main_container #email_message').text(`Email: ${userState.email}`);
                $('#main_container #role_message').text(`Role: ${roleAsString(userState.role)}`);
                showMessage("Success.");
                retrieveCourses();
            } else {
                console.log("User is not logged in.");
                // User is not logged in, show the login form
                $('#login_page').show();
                $('#main_container').hide();
            }
        }


        $('#login_request').submit(async function(e) {
            e.preventDefault();
            let username = $('#login_request input[name="username"]').val();
            let password = $('#login_request input[name="password"]').val();

            let form_data = {
                username: username,
                password: password
            };
            console.log(form_data);
            $.ajax({
                url: server_url + '/login',
                type: 'POST',
                async: false,
                cache: false,
                data: JSON.stringify(form_data),
                contentType: 'application/json; charset=utf-8',
                xhrFields: { withCredentials: true },
                success: function(response) {
                    console.log(response);
                    if (response.logged_in) {
                        console.log("User is logged in.");
                        // reload the page content now that we are logged in
                        loadPageContent();
                    } else {
                        console.log("User is not logged in.");
                    }
                },
                error: function() {
                    console.log("Error logging in.");
                }
            });
        });


        $('#logout_request').submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: server_url + '/logout',
                type: 'POST',
                async: false,
                cache: false,
                xhrFields: { withCredentials: true },
                success: function(response) {
                    console.log(response);
                    if (response.logged_in === false) {
                        console.log("User is logged out.");
                        showMessage("Logged out.");
                    } else {
                        console.log("User is not logged out.");
                    }
                },
                error: function() {
                    console.log("Error logging out.");
                }
            });
            updateUserState();
            loadPageContent();
        });

        $('#register_request').submit(function(e) {
            e.preventDefault();
            let email = $('#register_request input[name="email"]').val();
            let username = $('#register_request input[name="username"]').val();
            let password = $('#register_request input[name="password"]').val();

            let form_data = {
                email: email,
                username: username,
                password: password
            };

            $.ajax({
                url: server_url + '/register',
                type: 'POST',
                async: false,
                cache: false,
                data: JSON.stringify(form_data),
                contentType: 'application/json; charset=utf-8',
                xhrFields: { withCredentials: true },
                success: function(response) {
                    console.log(response);
                    if (response.logged_in) {
                        console.log("User is logged in.");
                        // reload the page content now that we are logged in
                        loadPageContent();
                    } else {
                        console.log("User is not logged in."); 
                    }
                    showMessage("Registered. Please login.");
                },
                error: function() {
                    console.log("Error registering.");
                }
            });
        });


        $(document).ready(function() {
            loadPageContent(); // Call on page load
        });

    </script>
</body>
</html>
